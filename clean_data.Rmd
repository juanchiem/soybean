---
title: "Limpieza dataset"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

https://evamaerey.github.io/little_flipbooks_library/data_cleaning/data_cleaning#74 

https://www.gastonsanchez.com/r4strings/cleaning.html

```{r}
pacman::p_load(tidyverse) 

raw_dat <- readxl::read_excel(here::here("data", "Planilla soja Nodo Oeste - Juanchi.xlsx"),
                   .name_repair = janitor::make_clean_names) 
 
glimpse(raw_dat)
```

```{r}
dat <- raw_dat %>% 
  select(campana, zona, regional, localidad, clase_de_suelo, cultivo, 
         rinde = rendimiento_qq_ha,
         antecesor_invernal_18_1, 
         antecesor_estival_17_18, fecha_siembra =fecha_de_siembra_dia_mes, variedad, 
         GM = grupo_de_madurez, 
         espaciamiento_cm, densidad, riego, napa, 
         adversidad_1, dano_1 = percent_estimados_de_dano, adversidad_2, 
         dano_2 = percent_estimados_de_dano1) %>% 
  # filter(rinde > 10) %>%
  mutate(zona = replace_na(zona, '3'), 
         fecha_siembra = lubridate::ymd(fecha_siembra), 
         GM = str_squish(str_to_upper(gsub(',', '\\.', GM))), 
         dano_1 = as.numeric(replace_na(dano_1, '0')), 
         dano_2 = as.numeric(replace_na(dano_2, '0')),
         dano_tot = dano_1 + dano_2,
         cultivo = recode(cultivo,  # cambios manuales
                           'Soja 1°'= 'soja_1',
                           'Soja 2°'= 'soja_2')) %>% 
   mutate(
    variedad = stringi::stri_trans_general(variedad,"Latin-ASCII"),
    variedad = str_replace_all(variedad, c('STS|IPRO'), ""),
    variedad = str_to_upper(gsub(',', '\\.', variedad)),
    variedad = str_replace_all(variedad, pattern=" ", repl="")) %>% 
  mutate(riego = str_to_upper(gsub(',', '\\.', riego)))
  
str(dat)
glimpse(dat)
```

```{r}
dat %>%
  select(everything()) %>%  # replace to your needs
  summarise_all(funs(sum(is.na(.))))
```

- Regional

```{r}
# raw_dat %>% 
#   arrange(regional) %>%
#   pull(regional) %>% unique()

dat <- dat %>%
  mutate(regional = str_trim(string = regional),
         regional = str_to_title(regional), # capital letters
         regional = stringi::stri_trans_general(regional,"Latin-ASCII"), # sacar acentos
         regional = recode(regional,  # cambios manuales
                           'Vicuna Mackenna'= 'V. Mackenna',
                           Montecristo = "Monte Cristo",
                           "Los Surgentes Inriville" = "Los Surgentes-Inriville",
                           "Los Surgentes" = "Los Surgentes-Inriville"))
# dat %>% arrange(regional) %>% pull(`regional`) %>% unique()
```

- Localidad

```{r}
dat %>% arrange(localidad) %>% pull(localidad) %>% unique()

dat <- dat %>%
  mutate(localidad = str_to_title(localidad), # capital letters
         localidad = stringi::stri_trans_general(localidad,"Latin-ASCII"))  

dat %>% arrange(localidad) %>% pull(localidad) %>% unique()
```

- Fecha siembra

```{r}
# dat %>% select(campana, fecha_siembra)

dat <- dat %>% 
  mutate(season = campana) %>% 
  separate(campana, c("y_siembra","y_cosecha"), "/") %>%   
  mutate(y_cosecha = as.numeric(y_cosecha)+2000, 
         # fecha_siembra = format(fecha_siembra, "%d-%m"),
         siembra = if_else(fecha_siembra>2018-09-01, fecha ))  
```

- Variedad

```{r}
var_name <- dat %>%
  group_by(variedad) %>%
  filter(n()>1) %>% ungroup() %>% 
  mutate(
    variedad = stringi::stri_trans_general(variedad,"Latin-ASCII"),
    variedad = str_replace_all(variedad, c('STS|IPRO'), ""),
    variedad = str_to_upper(gsub(',', '\\.', variedad)),
    variedad = str_replace_all(variedad, pattern=" ", repl="")
    # variedad = recode(variedad,  
         #                   N5009= NA5009,
         #                   N5009= NA5009)
         ) %>% 
  arrange(variedad) %>% 
  filter(!variedad %in% c(NA, "OTRO", "VARIAS", "EXPERIMENTAL", "MEZCLA","0")) %>% 
  pull(variedad) %>% unique() 

var_name

dat %>% 
  filter(variedad %in% var_name) %>% 
  group_by(variedad) %>%
  filter(n()>1) %>% ungroup() %>%
    pull(variedad) %>% unique() 
#64 variedades 
```

```{r}
save(raw_dat, dat, var_name, file = here::here("soy_dat.Rdata"))
write_csv(dat, "data/clean_data.csv")
```
