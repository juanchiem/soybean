---
title: "Performance de variedades"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r message=FALSE, warning=FALSE, include=FALSE}
pacman::p_load(tidyverse) 
# dat <- read_csv(here::here("data/clean_data.csv"))
load(here::here("soy_dat.Rdata"))
```

Cuanto fue el potencial del rendimiento en cada ambiente (zona/año)

```{r}
potencial_ambiente <- 
  dat %>% 
  filter(dano_tot == 0, 
         rinde > 4, 
         riego == "NO") %>% 
  group_by(campana, zona, cultivo) %>%
  summarise(rinde_50 = median(rinde, na.rm = TRUE),
            rinde_95 = quantile(rinde, 0.95, na.rm = TRUE),
            .groups = 'drop') 

```

```{r}
potencial_ambiente %>%
  mutate(cultivo = recode(cultivo, 
                          'soja_1'= 'Soja 1°',
                          'soja_2'= 'Soja 2°')) %>% 
  ggplot(aes(zona, rinde_95, fill = cultivo)) + 
  geom_bar(
    position = "identity",
    stat = "identity",
    alpha = .5)+
  facet_grid(. ~ campana)+
  # theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  theme_bw()+
  labs(x = "Zona agroecológica", y = "Potencial de rendimiento - 95°(qq/ha)",
       fill = "")

ggsave(last_plot(), file = "plots/potencial_ambiente.png", width = 5, height = 3)

```

```{r}
dat <- left_join(x=dat, y=potencial_ambiente, 
                     by=c("zona",  "cultivo", "variedad")) %>%
  mutate_if(is.character, as.factor) 
```


```{r}
potencial_ambiente <- 
dat %>% 
  filter(dano_tot == 0, 
         rinde > 4, 
         riego == "NO") %>% 
  group_by(campana, zona, cultivo, variedad) %>%
  summarise(var_sup = sum(superficie, na.rm = TRUE),
            n_lotes = n(), 
            rinde_mediano = median(rinde, na.rm = TRUE),
            # rinde_20 = quantile(rinde, 0.2, na.rm = TRUE),
            # rinde_80 = quantile(rinde, 0.8, na.rm = TRUE),
            # cv = raster::cv(rinde),
            .groups = 'drop') %>%   
  filter(cultivo == "soja_1", zona ==".") %>%
  group_by(variedad) %>% 
  mutate(flag=n_distinct(campana)) %>%
  filter(flag==3) %>% 
  group_by(variedad) %>%
  mutate(sup=sum(var_sup)) %>%
  filter(sup>500) %>% #View
  mutate_if(is.character, as.factor) %>% 
  droplevels() %>% 
  ggplot(aes(x = campana, y = rinde_mediano, ))+
  geom_point(aes(col = variedad)) +
  geom_line(aes(group = variedad, col = variedad)) 

```


Como primer abordaje analizaremos por zona, solo aquellos cultivares:  
- sembrados las 3 campañas 
- En al menos 500 has 
- descartando lotes con algun nivel de estres declarado 
- lotes de al menos 5 qq/ha

```{r}
# group_by(zona, cultivo) %>% 
  # top_n(n = 10, wt = var_sup) %>% 
  # arrange(zona, cultivo) %>% 
  # na.omit() %>% 
  # mutate_if(is.numeric, list(~round(.,1)))

```

Rinde mediano (valor central), 20° y 80° percentil, por tipo de cultivo y GM

```{r}
# dat_top5 %>% data.frame %>% knitr::kable()
```

```{r}
dat_top <- semi_join(x=dat, y=dat_top0, by=c("zona",  "cultivo","variedad")) %>%
  mutate_if(is.character, as.factor) 
  
# levels(dat_top$zona) %>%  
#   map(
#     ~ subset(dat_top, zona == .) %>% 
#   ggplot(aes(variedad, rinde))+
#   geom_boxplot()+
#   facet_grid(campana ~ GM)
# )

dat_top %>% 
  filter(dano_tot == 0) %>% 
  group_by(campana, zona, cultivo, variedad) %>% 
  summarise(rinde = median(rinde),
            rinde_20 = quantile(rinde, 0.2, na.rm = T),
            rinde_80 = quantile(rinde, 0.8, na.rm = T)) %>% 
  filter(zona == 1,  
         cultivo == "soja_1") %>% 
  droplevels() %>% 
  ggplot(aes(x = reorder(variedad, -rinde), y = rinde)) +
  geom_bar(stat = "identity")+
  #   stat_summary(fun=median, position=position_dodge(width=0.95),geom="bar",
  #              colour="black",fill="grey90")+
  # stat_summary(fun.data=mean_sdl, geom="errorbar", width=0.2) +  
  facet_grid(. ~ campana)+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

### Soja de 1°

```{r}
mean_rinde <- dat_top5 %>% 
  group_by(cultivo, GM) %>% 
  summarise(rinde_mediano = mean(rinde_mediano))

mean_cv <- dat_top5 %>% 
  group_by(cultivo, GM) %>% 
  summarise(cv = mean(cv))

dat_top5 %>% 
  filter(cultivo == "soja_1") %>% 
  droplevels() %>%  
  ggplot(aes(x = cv, y = rinde_mediano))+
  geom_point()+
  ggrepel::geom_text_repel(aes( label = variedad))+
  # geom_label(aes(label = variedad, col = var_sup/1000))+
  # scale_colour_viridis_c(  direction = -1)+
  facet_wrap("GM", scales="fixed")+
  theme_bw()+
  labs(x = "Coeficiente de variación (%)", 
       y  = "Rendimiento mediano (qq/ha)", 
       title = "Soja 1° - Rendimiento de las 5 variedades mas sembradas por GM (2017 a 2020)")+
  geom_hline(aes(yintercept = rinde_mediano), mean_rinde %>% filter(cultivo =="soja_1"), linetype = 2)+
  geom_vline(aes(xintercept = cv), mean_cv %>% filter(cultivo =="soja_1"), linetype = 2)+
  cowplot:: background_grid(minor = c("none", "xy", "x", "y"), 
                            color.major = "grey95")
```

> el rinde mediano es mayor en los GM IV y III y tinen menor CV% que las
GM V y VI

### Soja de 2°

```{r}
dat_top5 %>% 
  filter(cultivo == "soja_2") %>% 
  droplevels() %>%  
  ggplot(aes(x = cv, y = rinde_mediano))+
  geom_point()+
  ggrepel::geom_text_repel(aes( label = variedad))+
  # geom_label(aes(label = variedad, col = var_sup/1000))+
  # scale_colour_viridis_c(  direction = -1)+
  facet_wrap("GM", scales="free")+
  theme_bw()+
  labs(x = "Coeficiente de variación (%)", 
       y  = "Rendimiento mediano (qq/ha)", 
       title = "Soja 2° - Rendimiento de las 5 variedades mas sembradas por GM (2017 a 2020)")+
  geom_hline(aes(yintercept = rinde_mediano), mean_rinde %>% filter(cultivo =="soja_2"), linetype = 2)+
  geom_vline(aes(xintercept = cv), mean_cv %>% filter(cultivo =="soja_2"), linetype = 2)+
  cowplot:: background_grid(minor = c("none", "xy", "x", "y"), 
                            color.major = "grey95")
```

```{r eval = F}
### Soja 1° 

dat_top5 %>%   
  filter(cultivo == "soja_1",
         zona ==1) %>% droplevels() %>%  
  ggplot(aes(
    x=reorder(factor(variedad), rinde_mediano),
    y=rinde_mediano))+
  facet_grid(GM ~.,  scales="free")  +
  coord_flip()+
  geom_pointrange(aes(ymin = rinde_20, ymax = rinde_80))
# stat_summary(fun="mean", geom="point", size=2)+
  # stat_summary(fun.data = mean_cl_boot, geom = "errorbar", color="blue", width=0.2)

dat %>%  
  mutate(id = paste0(campana, "-",variedad)) %>% 
  filter(id %in% var_secano, 
         cultivo == 'soja_2') %>%
  ggplot(aes(x=reorder(factor(variedad), rinde, FUN=median),
             y=rinde))+
  facet_grid(GM ~ campana,  scales="free", switch="y")  +
  coord_flip()+
  stat_summary(fun="mean", geom="point", size=2)+
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", color="blue", width=0.2)
```

- Evolución de uso de biotecnologia por campaña

```{r}
rr_sum <- dat %>% 
  group_by(zona, campana, tecno_rr) %>%
  summarise(lotes = n()) %>%
  # group_by(zona, campana, tecno_rr) %>%
  # summarise(lotes = n()) %>%
  group_by(zona, campana) %>%
  mutate(perc = lotes/sum(lotes)) %>%
  separate(campana, c("year",NA), "/") %>% 
  ungroup()

rr_sum %>% 
  drop_na(tecno_rr) %>% 
  ggplot(aes(x = factor(year), 
             y = perc*100, 
             col = factor(tecno_rr), 
             group =factor(tecno_rr)))+
  geom_line()+
  facet_grid(.~zona,  scales="free")  +
  labs(x = NULL, col=NULL, y = "% del área de cada zona", 
       title = "Evolucion de superficie de adopción de biotecnología RR por zona")+
  ggrepel::geom_text_repel(
    data = rr_sum %>% filter(year == 2019),
    aes(label = tecno_rr),
    size =3, 
    nudge_x = 0.1) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  guides(col = "none")

# gs4_auth()
# sheet_write(bio_sum, ss = soja, sheet = "var_x_bio")
```

```{r}
sts_sum <- dat %>% 
  drop_na(tecno_sts) %>%
  group_by(zona, campana, tecno_sts) %>% 
  summarise(lotes = n()) %>% 
  # group_by(zona, campana) %>%
  # mutate(perc = lotes/sum(lotes)) %>%
  separate(campana, c("year",NA), "/") %>%
  ungroup()

sts_sum %>% 
  filter(tecno_sts == "STS") %>% 
  drop_na(tecno_sts) %>% 
  ggplot(aes(x = factor(year), 
             y = lotes, 
             col = factor(zona), 
             group =factor(zona)))+
  geom_line()+
  # facet_grid(.~zona,  scales="free")  +
  labs(x = NULL, col=NULL, y = "Lotes por zona", 
       title = "Evolucion de superficie de adopción de biotecnología sts")+
  # ggrepel::geom_text_repel(
  #   data = sts_sum %>% filter(year == 2019),
  #   aes(label = zona),
  #   size =3, 
  #   nudge_x = 0.1) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) #+
  guides(col = "ona")
```

> esta raro esto



- Efecto napa y agua a la siembra por año y por zona

```{r, eval=FALSE}
dat %>% 
  mutate(
agua_inicio=stringi::stri_trans_general(agua_inicio,"Latin-ASCII"), # sacar acentos
agua_inicio = recode(agua_inicio,  # cambios manuales
                           '0'= 'VACIO')) %>% 
  ggplot(aes(x=agua_inicio, y=rinde))+
  geom_point(aes(col=napa), alpha =0.5, pch = 21)+
  facet_grid(zona~ cultivo, scales="free")+
  geom_smooth(aes(col=campana), se = F, 
              span = 1 
              )+
  scale_x_date(date_breaks = "10 day", date_labels =  "%d-%b")+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  labs(x = "Fecha de siembra", y = "Rendimiento (qq/ha)")
```


- Arbol de regresion para rendimiento: que variables explican cada rango de rendimiento??
