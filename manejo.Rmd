---
title: "Manejo"
output: html_document
---

```{r message=FALSE, warning=FALSE, include=FALSE}
pacman::p_load(tidyverse) 
# dat <- read_csv(here::here("data/clean_data.csv"))
load(here::here("data/soy_dat.Rdata"))
```

## Ventanas de siembra por zona / GM

```{r}
pacman::p_load(scales, ggridges)
```

```{r}
dat %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-31') %>%
  mutate(cultivo = recode_factor(cultivo, `soja_1` = "Soja 1°", `soja_2` = "Soja 2°" )) %>% 
  ggplot(aes(x = fecha_siembra, y = zona)) +
  geom_density_ridges(aes(stat ="density", fill = cultivo), 
                      alpha =0.5,
                      jittered_points = TRUE, scale = .5, rel_min_height = .01,
                      point_shape = "|", point_size = 1, size = 0.25,
                      position = position_points_jitter(height = 0))+
  scale_x_date(date_labels = "%^b", breaks = date_breaks("1 months"), expand = c(0,0))+
  labs(x= "", y = "Zona", 
       title = "Ventanas de siembra soja 1°/2°" ,
       fill = "")+
  theme_bw(base_size = 13) + 
  theme(axis.text.x = element_text(hjust = -0.1))#angle = 60,

ggsave(last_plot(), file = "plots/ventanas_siembra_cultivo1_2.png", width = 5, height = 4)
```

### Soja 1° 

```{r}
dat %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-31', 
         cultivo == "soja_1") %>%
  ggplot(aes(x = fecha_siembra, y = zona)) +
  geom_density_ridges(aes(stat ="density", fill = campana), 
                      alpha =0.5,
                      jittered_points = TRUE, scale = .7, rel_min_height = .01,
                      point_shape = "|", point_size = 1, size = 0.25,
                      position = position_points_jitter(height = 0))+
  scale_x_date(date_labels = "%^b", breaks = date_breaks("1 months"), expand = c(0,0))+
  labs(x= "", y = "Zona", 
       title = "Evolución inter-anual de ventanas de siembra" ,
       fill = "")+
  theme_bw(base_size = 13) + 
  theme(axis.text.x = element_text(hjust = -0.1))#angle = 60,

ggsave(last_plot(), file = "plots/ventanas_siembra_campana.png", width = 5, height = 4)
```


```{r}
dat %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-31', 
         cultivo == "soja_1") %>%
  ggplot(aes(x = fecha_siembra, y = zona)) +
  geom_density_ridges(aes(stat ="density", fill = GM), 
                      alpha =0.5,
                      jittered_points = TRUE, scale = .5, rel_min_height = .01,
                      point_shape = "|", point_size = 1, size = 0.25,
                      position = position_points_jitter(height = 0))+
  scale_x_date(date_labels = "%^b", breaks = date_breaks("1 months"), expand = c(0,0))+
  facet_wrap("campana")+
  labs(x= "", y = "Zona", fill = "GM", 
       title = "Ventanas de siembra soja 1°" )+
  theme_bw(base_size = 13) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

ggsave(last_plot(), file = "plots/ventanas_siembra_sj1_GM.png", width = 5, height = 4)
```

### Soja 2° 

```{r}
dat %>% 
  filter(fecha_siembra > '2018-11-15', 
         fecha_siembra < '2018-12-31', 
         cultivo == "soja_2") %>%
  ggplot(aes(x = fecha_siembra, y = zona)) +
  geom_density_ridges(aes(stat ="density", fill = GM), 
                      alpha =0.5,
                      jittered_points = TRUE, scale = .5, rel_min_height = .01,
                      point_shape = "|", point_size = 1, size = 0.25,
                      position = position_points_jitter(height = 0))+
  scale_x_date(date_labels = "%^b", breaks = date_breaks("1 months"), expand = c(0,0))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+ 
  facet_wrap("campana")+
  labs(x= "", y = "Zona", fill = "GM", 
       title = "Ventanas de siembra soja 2°" )+  
  theme_bw(base_size = 13) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

ggsave(last_plot(), file = "plots/ventanas_siembra_sj2.png", width = 5.5, height = 4)
```

## Rendimientos por fecha de siembra x zona

(El suavizado de la tendencia esta hecho con modelo polinomial de grado 2, o sea que puede ser lineal o cuadratico el ajuste)

Soja 1°

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
dat %>% drop_na(rinde) %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-29',
         rinde>4,
         cultivo == "soja_1") %>%
  mutate(zona = fct_rev(zona)) %>% 
  ggplot(aes(x=fecha_siembra, y=rinde))+
  geom_point(aes(col=campana), alpha =0.5, size=0.8)+
  facet_grid(zona~., scales="free_x")+
  geom_smooth(aes(col=campana), se = F, method = 'lm', formula = y ~ poly(x, 2)) +
  scale_x_date(date_breaks = "15 day", date_labels =  "%d %b")+
  labs(x = "Fecha de siembra", y = "Rendimiento (qq/ha)", col ="")+
  theme_bw(base_size = 13) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1), 
        legend.position = "top")

ggsave(last_plot(), file = "plots/rinde_Fsiembra_sj1.png", w=3.5, h=5)
```


Zona 1 x GM

```{r}
dat %>% drop_na(rinde) %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-29',
         rinde>4,
         cultivo == "soja_1", 
         zona==1) %>%
  mutate(zona = fct_rev(zona)) %>% 
  ggplot(aes(x=fecha_siembra, y=rinde))+
  geom_point(aes(col=campana), alpha =0.5, size=0.8)+
  facet_grid(.~GM, scales="free_x")+
  # geom_smooth(aes(col=campana), se = F, span=1) +
  # geom_smooth(aes(col=campana), method = "lm", formula = y ~ splines::bs(x, 1), se = T) +
  # geom_smooth(aes(col=campana), se = F, method = 'lm', formula = y ~ poly(x, 2)) +
  geom_quantile(aes(col=campana))+
  # geom_flquantiles(probs=c(0.90), alpha=0.15)+
  # geom_quantile(aes(col=campana), quantiles = 0.8, linetype = 2)+
  scale_x_date(date_breaks = "15 day", date_labels =  "%d %b")+
  labs(x = "Fecha de siembra", y = "Rendimiento (qq/ha)", col ="")+
  theme_bw(base_size = 13) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1), 
        legend.position = "top")

ggsave(last_plot(), file = "plots/rinde_Fsiembra_sj1_zona1_GM.png", w=3.5, h=5)

data(ple4)
plot(rlnorm(200, fbar(ple4), 0.15))
```

Zona 2 x GM

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
dat %>% drop_na(rinde) %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-29',
         rinde>4,
         cultivo == "soja_1", 
         zona==2) %>%
  mutate(zona = fct_rev(zona)) %>% 
  ggplot(aes(x=fecha_siembra, y=rinde))+
  geom_point(aes(col=campana), alpha =0.5, size=0.8)+
  facet_grid(.~GM, scales="free_x")+
  # geom_smooth(aes(col=campana), se = F, span=1) +
  geom_smooth(aes(col=campana), se = F, method = 'lm', formula = y ~ poly(x, 2)) +
  # geom_quantile(aes(col=campana), quantiles = 0.5)+
  # geom_quantile(aes(col=campana), quantiles = 0.90, linetype = 2)+
  scale_x_date(date_breaks = "15 day", date_labels =  "%d %b")+
  labs(x = "Fecha de siembra", y = "Rendimiento (qq/ha)", col ="")+
  theme_bw(base_size = 13) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1), 
        legend.position = "top")

ggsave(last_plot(), file = "plots/rinde_Fsiembra_sj1_zona2_GM.png", w=3.5, h=5)
```



```{r}
dat %>% drop_na(rinde) %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-29',
         rinde>4,
         cultivo == "soja_1") %>%
  mutate(zona = fct_rev(zona)) %>% 
  ggplot(aes(x=GM, y=rinde))+
  geom_boxplot()+
  geom_point(alpha =0.5, size=0.8)+
  facet_grid(zona ~ campana, scales="free_x")+
  geom_smooth(se = F, method = 'lm', formula = y ~ poly(x, 2)) +
  labs(x = "GM", y = "Rendimiento (qq/ha)", col ="")+
  theme_bw(base_size = 13) 
  # theme(axis.text.x = element_text(angle = 60, hjust = 1), 
        # legend.position = "top")
ggsave(last_plot(), file = "plots/sj1_rinde_x_GM_zona_campana.png", w =5, h = 5)

```


Soja 2°

```{r}
dat %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-31',
         !is.na(rinde), 
         rinde>4) %>%
  filter(!(cultivo == 'soja_2' & zona ==1 & campana =="2018/19")) %>%
  filter(!(cultivo == "soja_2" & fecha_siembra < '2018-12-01'), 
         cultivo == "soja_2") %>%
  mutate(zona = fct_rev(zona)) %>% 
  ggplot(aes(x=fecha_siembra, y=rinde))+
  geom_point(aes(col=campana), alpha =0.5, size=0.8)+
  facet_grid(zona~., scales="free_x")+
  geom_smooth(aes(col=campana), se = F, method = 'lm', formula = y ~ poly(x, 1)) +
  scale_x_date(date_breaks = "15 day", date_labels =  "%d %b")+
  labs(x = "Fecha de siembra", y = "Rendimiento (qq/ha)", col ="")+
  theme_bw(base_size = 13) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1), 
        legend.position = "top")

ggsave(last_plot(), file = "plots/rinde_Fsiembra_sj2.png", w=3, h=5)
```


```{r}
library(lubridate)
dat %>% drop_na(rinde) %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-29',
         rinde>4,
         cultivo == "soja_1", zona == 5) %>%
  #   group_by(fecha_siembra=if_else(day(fecha_siembra) >= 30,
  #                       floor_date(fecha_siembra, "20 days"),
  #                       floor_date(fecha_siembra, "10 days"))) %>%
  # summarize(yield_mean = mean(rinde),
  #           days = n()) %>%
  mutate(zona = fct_rev(zona)) %>% 
  ggplot(aes(x=as.POSIXct(fecha_siembra), y=rinde))+
  geom_boxplot(aes(colour = GM), varwidth = F)+
  # geom_point(alpha =0.5, size=0.8)+
  facet_grid( .~ campana, scales="free_x")+
  # geom_smooth(se = F, method = 'lm', formula = y ~ poly(x, 2)) +
  labs(x = "GM", y = "Rendimiento (qq/ha)", col ="")+
  theme_bw(base_size = 13) +
  scale_x_datetime(breaks = date_breaks("15 days")) 
    
  # theme(axis.text.x = element_text(angle = 60, hjust = 1), 
        # legend.position = "top")
ggsave(last_plot(), file = "plots/sj1_rinde_x_GM_zona_campana.png", w =5, h = 5)

```

