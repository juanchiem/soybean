---
title: "Distribución de superficie de siembra"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r message=FALSE, warning=FALSE, include=FALSE}
pacman::p_load(tidyverse) 
# dat <- read_csv(here::here("data/clean_data.csv"))
load(here::here("data/soy_dat.Rdata"))
glimpse(dat)
```

# Lote tipico por zona

```{r}
dat %>% select(zona, superficie, rinde) %>% 
  rename(`Rinde (qq/ha)` = rinde, `Superficie (ha)` = superficie) %>% 
  pivot_longer(-zona) %>% 
  group_by(zona, name) %>% summarise(value = round(median(value, na.rm = T),0)) -> datm

dat %>% 
  select(zona, superficie, rinde) %>% 
  rename(`Superficie (ha)` = superficie, `Rinde (qq/ha)` = rinde) %>% 
  pivot_longer(-zona) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(name = forcats::fct_rev(name)) -> long 

histo5 <- levels(long$zona) %>% 
  map(~ subset(long, zona == .) %>% 
        ggplot(aes(x = value))+
        geom_histogram(fill = "steelblue")+
        facet_wrap("name", scales = "free")+
        geom_rug()+
        labs(x = "Valores observados", y="Cantidad de casos", 
             title = paste0("Lote típico de la zona ", .))+
        theme_bw(base_size = 12)+
        cowplot:: background_grid(minor = c("none", "xy", "x", "y"),
                                  color.major = "grey95")+
        geom_vline(data = subset(datm, zona == .), aes(xintercept = value),col='red',size=1)+
        geom_text(data = subset(datm, zona == .), aes(x = value, label = value, y = -Inf, vjust = -1), col  = "white", fontface = 2)
  )

ggsave(histo5[[1]], file = "plots_superficies/lote_tipico_zona1.png", width = 4, height = 3)
ggsave(histo5[[2]], file = "plots_superficies/lote_tipico_zona2.png", width = 4, height = 3)
ggsave(histo5[[3]], file = "plots_superficies/lote_tipico_zona3.png", width = 4, height = 3)
ggsave(histo5[[4]], file = "plots_superficies/lote_tipico_zona4.png", width = 4, height = 3)
ggsave(histo5[[5]], file = "plots_superficies/lote_tipico_zona5.png", width = 4, height = 3)
```


- Superficie por zona / regional / campaña

```{r}
dat %>% 
  group_by(campana, zona, regional) %>% 
  # filter(is.na(rinde))
  summarise(super = round(sum(superficie)/1000,0)) %>% 
  ungroup() %>% 
  # tally() %>% 
  mutate(campana = factor(campana),
         campana = forcats::fct_rev(campana),
         zona = factor(zona),
         regional = factor(regional)) %>% 
  # data.frame 
  drop_na(regional) %>% 
  ggplot(aes(
    x =reorder(regional, super, sum),
    y = super, fill = campana)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label = super), fontface = "bold", position = position_stack(vjust = 0.5), 
            size = 2)+
  facet_grid(zona ~ .,  scales="free", space = "free")+
  coord_flip()+
  labs(x = "", y = "Superficie (miles de ha)", fill = "", 
       title =  "Distribución de superficie según zona, regional y campaña\n")+
  geom_text(
    aes(x = reorder(regional, super, sum),
        label = stat(y), group = regional),
    stat = 'summary', fun = sum, 
    vjust = 0.5, hjust=-.1, size = 3)+ 
   theme_bw(base_size = 12) %+replace% 
  theme(plot.title = element_text(hjust = 1.5, vjust = 1))

ggsave(last_plot(), file = "plots_superficies/sup_campana_zona.png", width = 7, height = 4)

```

```{r, eval=FALSE}
#Cantidad de datos/celdas vacias por variable
dat %>%
  summarise_all(funs( = <- <- 