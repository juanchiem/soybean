---
output: github_document
always_allow_html: true
editor_options: 
  chunk_output_type: console
  
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = F, message=FALSE, warning=FALSE, 
  comment = "#>"
)
```

Referencias para tener en cuenta: 

[Revista Horizonte digital](https://issuu.com/horizonteadigital/docs/ha_130)


```{r message=FALSE, warning=FALSE, include=FALSE}
pacman::p_load(tidyverse) 
# dat <- read_csv(here::here("data/clean_data.csv"))
load(here::here("soy_dat.Rdata"))
```

## Dataset 

```{r}
glimpse(dat)
```

- Nro de observaciones por campaña / ecoregión / regional

```{r}
dat %>% 
  group_by(campana, zona, regional) %>% 
  tally() %>% ungroup() %>% 
  mutate(campana = factor(campana),
         campana = forcats::fct_rev(campana)) %>% 
  ggplot(aes(
    x =reorder(regional, n, sum),
    y = n, fill = campana)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), size = 2)+
  facet_grid(zona ~ .,  scales="free", space = "free")+
  coord_flip()+
  labs(x = "Regional", y = "Cantidad de lotes", fill = "")+
  geom_text(
    aes(x = reorder(regional, n, sum),
        label = stat(y), group = regional),
    stat = 'summary', fun = sum, 
    vjust = 0.5, hjust=-.1, size = 3)
```

- Cantidad de datos/faltantes por variable

```{r}
dat %>%
  summarise_all(funs(sum(!is.na(.)))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "datos") %>% 
  left_join(by="variable", 
            dat %>%
    summarise_all(funs(sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "datos_faltantes") 
  ) %>% 
  knitr::kable()
```

## Distribución de variedades: superficie (tamaño de cuadrados) y rendimientos (intensidad de color) por GM 

```{r}
library(treemap)

dat_sum <- dat %>% 
  group_by(cultivo, GM, variedad) %>%
  summarise(var_lotes= n(), 
            var_sup = sum(superficie, na.rm = TRUE),
            rinde_medio = median(rinde, na.rm = TRUE))
# dat_sum
```


```{r}
treemap(dat_sum %>% filter(cultivo =="soja_1"),
        index=c("GM", "variedad"),
        vSize="var_sup",
        vColor="rinde_medio",
        type = "value",
        title="Soja de 1° - Uso de variedades por grupo de madurez",
        title.legend = "Rendimiento medio (qq/ha)"
)
```

```{r}
treemap(dat_sum %>% filter(cultivo =="soja_2"),
        index = c("GM", "variedad"),
        vSize = "var_sup",
        vColor = "rinde_medio",
        type = "value",
        title = "Soja de 2° - Uso de variedades por grupo de madurez",
        title.legend = "Rendimiento medio (qq/ha)"
)
```

## Fecha de siembra x GM

- Evolución de fecha de siembra por zona

```{r}
pacman::p_load(scales, ggridges)

dat %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-31') %>%
  ggplot(aes(x = fecha_siembra, y = factor(zona))) +
  stat_density_ridges(aes(fill = GM), 
                      scale = .95, alpha =0.7, 
                      # quantile_lines = TRUE, quantiles = 2
  )+
  scale_x_date(date_labels = "%b", breaks = date_breaks("1 months"))+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+ 
  facet_wrap("campana")+
  labs(x= "Fecha de siembra", y = "Zona agroecológica")
```

## Fecha de siembra x rinde

- Rendimientos por fecha de siembra x zona

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
dat %>% 
  filter(fecha_siembra > '2018-09-15', 
         fecha_siembra < '2018-12-31') %>%
  filter(!is.na(rinde)) %>%
  filter(rinde>2) %>%
  filter(!(cultivo == 'soja_2' & zona ==1 & campana =="2018/19")) %>%
  filter(!(cultivo == "soja_2" & fecha_siembra < '2018-12-01')) %>% 
  ggplot(aes(x=fecha_siembra, y=rinde))+
  geom_point(aes(col=campana), alpha =0.5, pch = 21)+
  facet_grid(zona~ cultivo, scales="free")+
  geom_smooth(aes(col=campana), se = F, 
              span = 1 
              )+
  scale_x_date(date_breaks = "10 day", date_labels =  "%d-%b")+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  labs(x = "Fecha de siembra", y = "Rendimiento (qq/ha)")
```

> Obs: elimine siembras de soja 2° anteriores al 1/12. Algo similar habria que hacer respecto a las soja 1°: eliminar siembras posteriores a 15/12? 

- Tomar las 5 variedades mas sembradas de cada GM y ver distribucion de rendimientos (por zona, para no meter ruido del potencial de las mismas??

## Variedades

```{r, eval=FALSE}
dat %>% 
  group_by(GM, variedad) %>%
  tally() %>% 
  arrange(GM, desc(n)) #%>% 
  # knitr::kable()
```

```{r}
dat %>%  
  filter(variedad %in% var_name, 
         dano_tot == 0, 
         rinde > 5, 
         riego == "NO") %>% 
  count(campana, variedad) %>% 
  arrange(n) %>% 
  filter(n>4) %>%   
  mutate(id = paste0(campana, "-",variedad)) %>% 
  pull(id) %>% unique() -> var_secano
```

### Soja 1° 

```{r fig.height=10}
#http://stulp.gmw.rug.nl/ggplotworkshop/comparinggroupstatistics.html 
dat %>%  
  mutate(id = paste0(campana, "-",variedad)) %>% 
  filter(id %in% var_secano, 
         GM %in% c("IV","V"),
         cultivo == 'soja_1') %>% 
  ggplot(aes(
    x=variedad,
    # x=reorder(factor(variedad), rinde, FUN=median),
             y=rinde))+
  facet_grid(GM ~ campana,  scales="free", switch="y")  +
  coord_flip()+
  stat_summary(fun="mean", geom="point", size=2)+
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", color="blue", width=0.2)
```

### Soja 2°

```{r fig.height=10}
dat %>%  
  mutate(id = paste0(campana, "-",variedad)) %>% 
  filter(id %in% var_secano, 
         cultivo == 'soja_2') %>%
  ggplot(aes(x=reorder(factor(variedad), rinde, FUN=median),
             y=rinde))+
  facet_grid(GM ~ campana,  scales="free", switch="y")  +
  coord_flip()+
  stat_summary(fun="mean", geom="point", size=2)+
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", color="blue", width=0.2)
```

- Evolución de uso de biotecnologia por campaña

```{r}
bio_sum <- dat %>% 
  group_by(
    campana,
    # variedad,
    biotecnologia) %>% 
  summarise(lotes = n(), 
            area = sum(superficie)) %>% 
  separate(campana, c("year",NA), "/") %>% 
  ungroup()

# gs4_auth()
# sheet_write(bio_sum, ss = soja, sheet = "var_x_bio")

bio_sum %>% 
  # filter(!biotecnologia %in%)
  ggplot(aes(x = factor(year), 
             y = area/1000, 
             col = factor(biotecnologia), 
             group =factor(biotecnologia)))+
  geom_line(alpa =0.5)+
  labs(x = NULL, col=NULL, y = "miles de has", 
       title = "Evolucion de superficie de adopción de biotecnología")+
  ggrepel::geom_text_repel(
    data = bio_sum %>% filter(year == 2019),
    aes(label = biotecnologia),
    size =3
  ) 
```

- Efecto napa y agua a la siembra por año y por zona

```{r, eval=FALSE}
dat %>% 
  
```


- Arbol de regresion para rendimiento: que variables explican cada rango de rendimiento??